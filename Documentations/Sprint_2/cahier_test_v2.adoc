= Cahier de Test - ParaCheck
:toc: left
:toclevels: 3

== Introduction
Ce document décrit les cas de test pour l’application mobile *ParaCheck*.  
Il inclut des scénarios de test détaillés, des prérequis, les étapes de validation, ainsi que les résultats attendus.  
L'objectif est de garantir que toutes les fonctionnalités de l’application fonctionnent correctement et répondent aux exigences spécifiées.  

== Sommaire

* <<Tests_Pages, Pages>>
** <<Contexte_Pages, Contexte>>
** <<Tests_Pages_List, Tests à effectuer>>
** <<Suivi_Pages, Suivi des Tests>>
* <<Tests_Models, Models>>
** <<Contexte_Models, Contexte>>
** <<Tests_Models_List, Tests à effectuer>>
** <<Suivi_Models, Suivi des Tests>>

// ==========================================================


[[Tests_Pages]]
== Pages

[[Contexte_Pages]]
=== Contexte
Les tests *Pages* valident les écrans/écrans-clés de l’application : rendu visuel, structure des widgets, navigation et éléments interactifs.  
Chaque page est testée pour :  
- Présence des éléments d’interface attendus (titres, icônes, sections).  
- Structure générale (scaffold, navigation, assets).  
- Contenu textuel attendu (labels, consignes, données JSON).  
- Comportement basique (smoke tests) et cas d’erreur/états vides si nécessaire.

[[Tests_Pages_List]]
=== Tests à effectuer

==== MaviePage
*Fichier source des tests* : `test/pages/mavie_test.dart`  
*Localisation dans l’application* : page *Mavie* (utilisée pour gérer les questionnaires MAVIE et accéder aux outils comme la respiration).  

Prérequis :
- Mock des assets requis (`mavie_questions.json`, images, manifests).  
- Flutter TestWidgets configuré.  

Cas de tests :  
1. **Chargement de l’asset JSON** : charger `assets/mavie_questions.json` via `rootBundle.loadString` et vérifier que les données sont non vides (première question `"Q1?"`).  
2. **Navigation (pushNamed)** : configurer `MaterialApp` avec `navigatorKey`, pousser la route `'/breathing'`, vérifier l’écran de destination.  
3. **Rendu de la page Mavie** : monter `MaviePage` et vérifier la présence d’un `AppScaffold` et du titre `"MAVIE"`.  

Résultats attendus :  
- Assets JSON chargeables et non vides.  
- Navigation `/breathing` fonctionnelle.  
- `AppScaffold` rendu avec titre `"MAVIE"`.

==== PersonalWeatherPage
*Fichier source des tests* : `test/pages/personal_weather_test.dart`  
*Localisation dans l’application* : page *Météo personnelle* (questionnaire / évaluation météorologique personnelle).

Prérequis :
- Mock des assets requis (`personal_weather_questions.json`, images, manifests).  
- Flutter TestWidgets configuré.

Cas de tests :  
1. **Chargement de l’asset JSON**  
   - Utiliser le mock `mockQuestionsAsset()` qui fournit `assets/personal_weather_questions.json`.  
   - Charger l’asset via `rootBundle.loadString` et `jsonDecode`.  
   - Vérifier que la liste résultante n’est pas vide et que la première entrée contient la question `"Q1?"`.  

2. **Navigation (pushNamed)**  
   - Construire un `MaterialApp` avec `navigatorKey` et une route `/mavie`.  
   - Appeler `navKey.currentState!.pushNamed('/mavie')`.  
   - Vérifier que l’écran cible (`ROUTE: mavie`) est rendu.

3. **Rendu de la page PersonalWeather**  
   - Monter `PersonalWeatherPage` dans un `MaterialApp`.  
   - Vérifier la présence d’un `AppScaffold`.  
   - Vérifier que le titre `"Météo personnelle"` est affiché.

Données de test :
- Le mock d’assets fournit un JSON minimal :  
  `[{"question":"Q1?","answer_ok":"OK","answer_bof":"BOF","answer_nok":"NOK"}]`  
- Images d’assets rendues via un PNG transparent en mémoire.

Résultats attendus :  
- JSON asset chargeable et non vide.  
- Navigation vers `/mavie` possible via `pushNamed`.  
- `AppScaffold` et titre `"Météo personnelle"` visibles.

Notes :
- Les mocks assurent l’indépendance des tests vis-à-vis des fichiers physiques.  
- Tests ciblent structure et navigation ; complément possible pour la logique du questionnaire (sélections de réponses, persistance, etc.).

==== HomePage
*Fichier source des tests* : `test/pages/home_page_test.dart`  
*Localisation dans l’application* : écran d'accueil affichant un résumé des derniers vols, accès à l'historique, pré-vol et post-vol.

Prérequis :
- `SharedPreferences` mockable (utiliser `SharedPreferences.setMockInitialValues`).
- Fonction utilitaire `seedFlights(List<Flight>)` appelée **avant** d'afficher `HomePage` pour préparer le repository en mémoire.
- Helper `makeFlight(...)` pour construire des objets `Flight`.

Cas de tests :

1. **Loading puis état vide**  
- Préparer le store : `await seedFlights(const []);` (aucun vol).  
- Monter la page : `await tester.pumpWidget(const MaterialApp(home: HomePage()));`  
- Vérifier la présence d'un `CircularProgressIndicator` pendant la résolution du `FutureBuilder`.  
- `await tester.pumpAndSettle();` puis vérifier l’état vide : présence de l’élément identifié par la clé `no_flights_text` et l’absence de `StatTile`.

2. **Affichage maximal de 3 StatTile (take(3))**  
- Seed du repo avec 4 vols via `seedFlights([...])` (vols f1..f4).  
- Monter la page et `pumpAndSettle()`.  
- Vérifier la présence de la list identifiée par la clé `flights_3last_list`.  
- Vérifier exactement 3 `StatTile` (findsNWidgets(3)).  
- Vérifications textuelles souples : `find.textContaining('Durée :')` et `find.textContaining('Altitude :')` trouvent 3 occurrences.

3. **Navigation (historique / pré-vol / post-vol) via Keys**  
- Monter `HomePage` dans un `MaterialApp` qui définit les routes `/flights_history`, `/flight_condition`, `/postflight_debrief` renvoyant des écrans factices (`AppScaffold` avec textes `HISTORY_SCREEN`, `PRE_SCREEN`, `POST_SCREEN`).  
- Simuler les taps sur les boutons via leurs `ValueKey`s :  
  - `flights_history_button` → vérifie `HISTORY_SCREEN`.  
  - `pre_flight_button` → vérifie `PRE_SCREEN`.  
  - `post_flight_button` → vérifie `POST_SCREEN`.  
- Utiliser `Navigator.pop()` entre les actions pour revenir à l'écran d'accueil.

4. **Affichage d’un message d’erreur si getAll() plante (JSON invalide)**  
- Injecter un JSON invalide directement dans le store mocké :  
  `SharedPreferences.setMockInitialValues({'flights_v1': 'not a json array'});`  
- Monter `HomePage`, `pumpAndSettle()` et vérifier la présence d’un message contenant `Erreur de chargement`.

Données de test :
- Exemples de vols fournis par `makeFlight(...)` (id, site, date, duration, altitude).
- SharedPreferences mockées pour simuler différents états (vide, plusieurs vols, JSON invalide).

Résultats attendus :
- Le spinner s’affiche puis l’état vide est rendu lorsque la liste est vide.  
- Lorsque plus de 3 vols sont présents, seules 3 `StatTile` sont affichées (les 3 derniers).  
- Les boutons mènent bien aux routes attendues.  
- En cas de JSON invalide, un message d’erreur explicite est affiché.

Notes :
- `seedFlights` doit être appelée **avant** de monter `HomePage`, sinon le repository aura déjà essayé de lire les données.  
- Les tests font de la vérification fonctionnelle / UI (smoke + cas d’erreur). On peut ajouter des tests de tri/ordre des vols et de formats d’affichage si souhaité (ex. format date/durée).

==== FlightsHistoryPage
*Fichier source des tests* : `test/pages/flights_history_test.dart`  
*Localisation dans l’application* : écran d'historique des vols (liste complète, suppression, détails via bottom sheet, rafraîchissement).

Prérequis :
- `SharedPreferences` mockable (`SharedPreferences.setMockInitialValues`).
- Helpers `makeFlight(...)` et `seedFlights(List<Flight>)` pour préparer l'état du repo avant d'afficher la page.
- Page rendue dans un `MaterialApp` pour permettre les animations, bottom sheet et navigation.

Cas de tests :

1. **Loading → Empty state**  
- Appeler `await seedFlights(const [])` puis monter `FlightsHistoryPage`.  
- Vérifier le `CircularProgressIndicator` pendant le chargement.  
- Après `pumpAndSettle()`, vérifier l’état vide : icône `Icons.hourglass_empty_rounded` et texte `Aucun vol enregistré pour le moment.`.

2. **Affiche la liste des vols (2 items)**  
- Seed avec 2 vols (ex. Organya, Annecy).  
- Monter la page, `pumpAndSettle()` et vérifier : deux `ListTile`, présence des noms de site (`Organya`, `Annecy`) et présence de puces (`•`) dans les sous-titres (date • durée • altitude) pour chaque item.

3. **Tap → bottom sheet (sans radar)**  
- Seed avec 1 vol (site `Sornin`).  
- Taper sur le titre `Sornin`.  
- Laisser jouer l’animation du bottom sheet (`pump`, `pump(Duration(...))`, `pumpAndSettle()`).  
- Vérifier la présence d’un `BottomSheet`.  
- Vérifier le contenu attendu : titre (`Sornin`), textes `Date :`, `Durée :`, `Altitude max :`, et le message `Aucune rose enregistrée pour ce vol.`.  
- Fermer via le bouton `Fermer` (TextButton) et vérifier la disparition du sheet.

4. **Suppression d’un vol via le dialog + snackbar**  
- Seed avec 2 vols (Organya, Annecy).  
- Taper sur l’icône `Supprimer` (ciblée par `tooltip='Supprimer'`) du premier item.  
- Confirmer dans le dialog (`FilledButton` texte `Supprimer`).  
- Vérifier la présence d’un `Snackbar` avec `Vol supprimé`.  
- Vérifier que la liste s’est mise à jour (1 item restant).

5. **Pull-to-refresh → recharge la liste (1 → 2 items)**  
- Seed initial avec 1 vol.  
- Afficher la page et vérifier 1 `ListTile`.  
- Pendant que la page est affichée, ajouter un vol au repo via `SharedPrefsFlightRepository().add(...)`.  
- Déclencher le `RefreshIndicator` par un `drag` important sur la `ListView`.  
- Laisser le onRefresh se jouer (`pump(Duration(seconds:1))` + `pumpAndSettle()`).  
- Vérifier que la liste reflète maintenant 2 items.

6. **Erreur de chargement (JSON invalide) → message d’erreur**  
- Injecter dans `SharedPreferences` une valeur invalide pour la clé `flights_v1` : `'not a json array'`.  
- Monter la page, `pumpAndSettle()` et vérifier la présence d’un message contenant `Erreur de chargement des vols`.

Données de test :
- Vols créés par `makeFlight(...)` avec champs : `id`, `site`, `date`, `duration`, `altitude`.
- Store mocké pour simuler états : vide, plusieurs vols, JSON invalide.

Résultats attendus :
- Chargement visuel suivi de l’état vide lorsque la base est vide.  
- Liste rendue correctement avec autant de `ListTile` que de vols seedés.  
- Bottom sheet affiche les détails attendus et gère l’absence de radar.  
- Suppression via dialog entraîne snackbar de confirmation et mise à jour de la liste.  
- Pull-to-refresh recharge la liste et affiche les nouveaux éléments.  
- En cas de JSON invalide, un message d’erreur explicite est affiché.

Notes :
- Le test timing-sensitive autour des animations (bottom sheet, snackbar, refresh) utilise `pump` avec de courtes durées pour laisser le framework animer les transitions.  
- Ces tests couvrent UI / comportement ; si souhaité, on peut ajouter des tests de tri, pagination, export d’items ou interaction avec le radar lorsqu’il est présent.

==== SettingsPage
*Fichier source des tests* : `test/pages/settings_test.dart`  
*Localisation dans l’application* : écran Paramètres (export/import de données, options de sauvegarde).

Prérequis :
- Environnement `flutter_test` configuré.
- `MaterialApp` autour de la page pour le rendu (`ThemeData(useMaterial3: true)`).

Cas de tests :

1. **Smoke — titre, section et notice**  
- Monter la page via `await tester.pumpWidget(wrap(const SettingsPage()));` puis `await tester.pumpAndSettle();`.  
- Vérifier la présence du titre principal `Paramètres`.  
- Vérifier la présence du `SectionTitle` intitulé `Sauvegarde & transfert (fichier .json)`.  
- Vérifier la présence d’un `AppNotice` d’introduction et des textes `Export / Import` et `Exportez vos données locales (SharedPreferences)` (ou début de ce texte).

2. **Boutons Export / Import et icône download**  
- Vérifier la présence des deux boutons libellés : `Exporter vers un fichier` et `Importer depuis un fichier`.  
- Vérifier que l’icône `Icons.download` est présente (sur le bouton d’export).

3. **Switch "Remplacer tout" bascule false → true**  
- Repérer le `Switch` et vérifier sa valeur initiale false.  
- Simuler un `tap` sur le `Switch` puis `pumpAndSettle()` et vérifier que sa valeur devient true.  
- Vérifier la présence du texte explicatif :  
  `"Remplacer tout lors de l'import (sinon, les données existantes sont conservées)"`.

Données de test :
- Page statique : pas d’assets externes requis pour ces vérifications de base.

Résultats attendus :
- Titre, section et notice visibles.  
- Boutons Export / Import et icône download présents.  
- Le `Switch` bascule correctement et le texte explicatif est affiché.

Notes :
- Tests sont des *smoke* et interaction simple ; on peut compléter par des tests d’export/import (mock des fichiers, permissions) si nécessaire.  
- Vérifier l’accessibilité (semantics) et l’orientation/responsive si souhaité.


[[Suivi_Pages]]
=== Suivi des Tests
[cols="3,1,2", options="header"]
|===
| Cas de Test | Statut | Commentaires
| MaviePage — Chargement JSON | ☑ | Asset chargé et question `"Q1?"` trouvée
| MaviePage — Navigation /breathing | ☑ | Route atteinte et écran `"ROUTE: breathing"` rendu
| MaviePage — Rendu AppScaffold | ☑ | Scaffold affiché avec titre `"MAVIE"`
| PersonalWeather — Chargement JSON | ☑ | Asset chargé et question `"Q1?"` trouvée
| PersonalWeather — Navigation /mavie | ☑ | Route atteinte et écran `"ROUTE: mavie"` rendu
| PersonalWeather — Rendu AppScaffold | ☑ | Scaffold affiché avec titre `"Météo personnelle"`
| HomePage — Loading puis état vide | ☑ | Spinner affiché puis `no_flights_text` présent
| HomePage — Affiche max 3 StatTile | ☑ | `flights_3last_list` présent, 3 StatTile rendues
| HomePage — Navigation via Keys | ☑ | Buttons mènent à HISTORY/PRE/POST screens
| HomePage — Erreur JSON invalide | ☑ | Message `Erreur de chargement` affiché
| FlightsHistoryPage — Loading → Empty state | ☑ | Spinner puis message "Aucun vol enregistré pour le moment."
| FlightsHistoryPage — Affiche liste (2 items) | ☑ | 2 ListTile rendues, site + sous-titre OK
| FlightsHistoryPage — Bottom sheet (tap) | ☑ | BottomSheet monté, détails affichés, "Aucune rose..." présent
| FlightsHistoryPage — Suppression + snackbar | ☑ | Dialog + Snackbar "Vol supprimé", liste mise à jour
| FlightsHistoryPage — Pull-to-refresh | ☑ | Refresh recharge la liste (1 → 2 items)
| FlightsHistoryPage — Erreur JSON invalide | ☑ | Message "Erreur de chargement des vols" affiché
| SettingsPage — Titre, section & notice | ☑ | Titre "Paramètres", SectionTitle et AppNotice présents
| SettingsPage — Boutons Export / Import & icône | ☑ | Boutons et icône `Icons.download` présents
| SettingsPage — Switch "Remplacer tout" | ☑ | Switch bascule false→true et texte explicatif affiché

|===




// ==========================================================

[[Tests_Models]]
== Models

[[Contexte_Models]]
=== Contexte
Les tests *Models* visent à vérifier l’intégrité et la cohérence des objets métiers utilisés par l’application.  
Chaque modèle est testé pour s’assurer que :  
- La sérialisation/désérialisation JSON fonctionne correctement.  
- Les conversions de types et formats utilitaires sont correctes.  
- Les scénarios d’erreurs sont bien gérés.  

[[Tests_Models_List]]
=== Tests à effectuer

==== DebriefEntry
*Localisation dans l’application* : utilisé dans la fonctionnalité de *Débriefing* (après un vol).

Cas de tests :  
- `toJson` doit produire la map `{label, value}`.  
- `fromJson` doit reconstruire correctement un objet valide.  
- Round-trip JSON (encodage + décodage) fonctionne avec une entrée unique et une liste d’entrées.  
- Gestion d’erreurs :  
  * Label ou value non-string → doit lever une erreur.  
  * Clés manquantes → doit lever une erreur.  

==== Flight
*Localisation dans l’application* : utilisé pour la gestion et l’enregistrement des vols (site, date, durée, altitude).

Cas de tests :  
- `toJson` doit contenir les champs principaux : `id`, `site`, `date`, `duration_sec`, `altitude_m`.  
- `fromJson` doit reconstruire un objet identique.  
- Conversion `Duration` ↔ secondes correcte (ex. 1h45 = 6300 s).  
- Date conservée en ISO 8601.  
- Méthodes utilitaires : `formatDuration(2h03) → "2h 3m"`.

==== Radar
*Localisation dans l’application* : utilisé pour représenter les scores d’auto-évaluation / évaluation (radar chart) sur plusieurs dimensions (pilotage, météo, gestion du stress, etc.).

Cas de tests :  
- `fromJson` doit caster des entiers en `double` lorsqu’il le faut (ex. `10` → `10.0`).  
- `average()` :  
  * retourne `0.0` si la map est vide.  
  * calcule la moyenne correcte sinon (ex. (10 + 14 + 16)/3).  
- `scoreOf(key)` : retourne la valeur si la clé existe, sinon `0.0`.  
- `toOrderedList(order)` : respecte l’ordre fourni et place `0.0` pour les clés inconnues.  
- `normalizedScores(requiredList)` :  
  * remplit les clés requises manquantes avec `0.0`.  
  * conserve les entrées « extra » existantes.  
  * ne perd aucune clé (taille attendue = requis + extras).  
- JSON round-trip : `toJsonString()` ↔ `fromJsonString()` doit restituer les mêmes scores.  
- `descriptionFor(feature)` :  
  * retourne la description attendue pour une clé connue (ex. `PIL - Pilotage` → texte descriptif).  
  * retourne `''` pour une clé inconnue.  
- `radarFeatures` : doit être non vide et contenir au minimum quelques clés majeures (`PIL - Pilotage`, `STS - Gestion du stress`).

[[Suivi_Models]]
=== Suivi des Tests
[cols="3,1,2", options="header"]
|===
| Cas de Test | Statut | Commentaires
| DebriefEntry.toJson | ☑ | Map correcte générée
| DebriefEntry.fromJson (valide) | ☑ | Objet reconstruit
| DebriefEntry Round-trip JSON (1 entrée) | ☑ | Fonctionnel
| DebriefEntry Round-trip JSON (liste) | ☑ | Fonctionnel
| DebriefEntry.fromJson (types invalides) | ☑ | Erreurs levées comme attendu
| Flight.toJson (champs principaux) | ☑ | Conversion correcte (id, site, durée, altitude)
| Flight.fromJson (valide) | ☑ | Objet reconstruit avec les bonnes valeurs
| Flight.date (ISO 8601) | ☑ | Conservation correcte
| Flight.duration (conversion) | ☑ | 1h45 = 6300s validé
| Flight.formatDuration | ☑ | "2h 3m" généré
| Radar.fromJson (int → double) | ☑ | Cast correct des ints en double
| Radar.average | ☑ | 0.0 si vide, moyenne correcte sinon
| Radar.scoreOf | ☑ | Retourne 0.0 pour clés absentes
| Radar.toOrderedList | ☑ | Respecte l’ordre, met 0.0 pour inconnus
| Radar.normalizedScores | ☑ | Remplit requis et préserve extras
| Radar.JSON round-trip | ☑ | toJsonString ↔ fromJsonString OK
| Radar.descriptionFor | ☑ | Description connue renvoyée; inconnue → ''
| Radar.radarFeatures | ☑ | Contient clés majeures
|===
